{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{% block title %}HuzzRate{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
<header class="site-header">
    <div class="container header-inner">
        <a class="logo" href="{% url 'core:index' %}">HuzzRate</a>
        <nav class="nav-right">
            {% if token %}
            <a href="{% url 'core:leaderboard' %}">Leaderboard</a>
            <span class="muted">|</span>
            <span class="token-badge">{{ token.value|slice:":8" }}...</span>
            <a href="{% url 'core:logout' %}" class="btn-link">Logout</a>
            <form method="post" action="{% url 'core:reset' %}" class="inline-reset">
                {% csrf_token %}
                <button type="submit" class="btn-reset" title="Reset your ratings">Reset</button>
            </form>
            {% else %}
            <a href="{% url 'core:login' %}">Login</a>
            {% endif %}
        </nav>
    </div>
</header>

    <main class="container">
        {% if messages %}
        <div class="messages">
            {% for m in messages %}
            <div class="msg {{ m.tags }}">{{ m }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    <footer class="site-footer">
        <div class="container"></div>
    </footer>

<script>
// Score button behavior for 2-scale rating
document.addEventListener('click', function(e){
    const btn = e.target.closest('.score-btn');
    if(!btn) return;

    const form = btn.closest('form');
    if(!form) return;

    // Find which scale this button belongs to
    const scaleDiv = btn.closest('.rating-scale');
    const scaleTitle = scaleDiv.querySelector('h4').textContent.toLowerCase();

    // Set the appropriate hidden input
    if (scaleTitle.includes('appearance')) {
        form.querySelector('input[name="appearance_score"]').value = btn.dataset.score;

        // Highlight the selected button for appearance
        const allAppearanceBtns = scaleDiv.querySelectorAll('.score-btn');
        allAppearanceBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    } else if (scaleTitle.includes('personality')) {
        form.querySelector('input[name="personality_score"]').value = btn.dataset.score;

        // Highlight the selected button for personality
        const allPersonalityBtns = scaleDiv.querySelectorAll('.score-btn');
        allPersonalityBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    // Check if both scores are set before submitting
    const appearanceScore = form.querySelector('input[name="appearance_score"]').value;
    const personalityScore = form.querySelector('input[name="personality_score"]').value;

    if (appearanceScore && personalityScore) {
        form.submit();
    }
});

// Modal and popup close handlers
document.addEventListener('click', function(e){
    // Close modals
    if(e.target.matches('.modal-close') || e.target.matches('.modal-overlay')){
        const modal = e.target.closest('.modal-overlay');
        if(modal) modal.classList.remove('open');

        // If it's the leaderboard popup, clear the session flag
        if(modal.classList.contains('leaderboard-popup')) {
            // You might want to send an AJAX request to clear the session flag
            // For now, it will reappear on page refresh until session expires
        }
    }

    // Close popup with continue button
    if(e.target.matches('.close-popup')) {
        const popup = e.target.closest('.modal-overlay');
        if(popup) popup.classList.remove('open');
    }
});
</script>
</body>
</html>